<html>
    <body>        

        <textarea cols="200" rows="20" id="datos">
            Marca temporal	Correo electrónico	 [Grupo 1. 08:30-10:30]	 [Grupo 2. 10:30-12:30]	 [Grupo 3. 12:30-14:30]	 [Grupo 4. 15:30-17:30]	 [Grupo 5. 17:30-19:30]	 [Grupo 6. 19:30-21:30]																
28/07/2021 19:41:47	3vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:40:47	13vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 20:41:47	23vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:41:47	33vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:41:47	43vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:41:47	53vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:41:47	63vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:41:47	73vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:41:47	83vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:41:47	93vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:41:47	103vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:41:57	4vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:41:57	14vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:41:57	24vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:41:57	3vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:41:57	44vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:41:57	54vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:41:57	64vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:41:57	74vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:41:57	84vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:41:57	94vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:41:57	104vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:42:07	5vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:42:07	15vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:42:07	25vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:42:07	35vrivas@ujaen.es	1	2	3	4	5	6	
28/07/2021 19:42:07	3vrivas@ujaen.es	3	4	5	6	1	2															
28/07/2021 19:42:07	45vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:42:07	55vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:42:07	65vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:42:07	75vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:42:07	85vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:42:07	95vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:42:07	105vrivas@ujaen.es	1	2	3	4	5	6																
28/07/2021 19:42:15	6vrivas@ujaen.es	6	5	4	3	2	1																
28/07/2021 19:42:15	16vrivas@ujaen.es	6	5	4	3	2	1																
28/07/2021 19:42:15	26vrivas@ujaen.es	6	5	4	3	2	1																
28/07/2021 19:42:15	36vrivas@ujaen.es	6	5	4	3	2	1																
28/07/2021 19:42:15	46vrivas@ujaen.es	6	5	4	3	2	1																
28/07/2021 19:42:15	56vrivas@ujaen.es	6	5	4	3	2	1																
28/07/2021 19:42:15	66vrivas@ujaen.es	6	5	4	3	2	1																
28/07/2021 19:42:15	76vrivas@ujaen.es	6	5	4	3	2	1																
28/07/2021 19:42:15	86vrivas@ujaen.es	6	5	4	3	2	1																
28/07/2021 19:42:15	96vrivas@ujaen.es	6	5	4	3	2	1																
28/07/2021 19:42:15	106vrivas@ujaen.es	6	5	4	3	2	1																
28/07/2021 19:42:24	7vrivas@ujaen.es	3	2	4	1	5	6																
28/07/2021 19:42:24	17vrivas@ujaen.es	3	2	4	1	5	6																
28/07/2021 19:42:24	27vrivas@ujaen.es	3	2	4	1	5	6																
28/07/2021 19:42:24	37vrivas@ujaen.es	3	2	4	1	5	6																
28/07/2021 19:42:24	47vrivas@ujaen.es	3	2	4	1	5	6																
28/07/2021 19:42:24	57vrivas@ujaen.es	3	2	4	1	5	6																
28/07/2021 19:42:24	67vrivas@ujaen.es	3	2	4	1	5	6																
28/07/2021 19:42:24	77vrivas@ujaen.es	3	2	4	1	5	6																
28/07/2021 19:42:24	87vrivas@ujaen.es	3	2	4	1	5	6																
28/07/2021 19:42:24	97vrivas@ujaen.es	3	2	4	1	5	6																
28/07/2021 19:42:24	107vrivas@ujaen.es	3	2	4	1	5	6																
28/07/2021 19:42:34	8vrivas@ujaen.es	5	4	3	2	1	6																
28/07/2021 19:42:34	18vrivas@ujaen.es	5	4	3	2	1	6																
28/07/2021 19:42:34	28vrivas@ujaen.es	5	4	3	2	1	6																
28/07/2021 19:42:34	38vrivas@ujaen.es	5	4	3	2	1	6																
28/07/2021 19:42:34	48vrivas@ujaen.es	5	4	3	2	1	6																
28/07/2021 19:42:34	58vrivas@ujaen.es	5	4	3	2	1	6																
28/07/2021 19:42:34	68vrivas@ujaen.es	5	4	3	2	1	6																
28/07/2021 19:42:34	78vrivas@ujaen.es	5	4	3	2	1	6																
28/07/2021 19:42:34	88vrivas@ujaen.es	5	4	3	2	1	6																
28/07/2021 19:42:34	98vrivas@ujaen.es	5	4	3	2	1	6																
28/07/2021 19:42:34	108vrivas@ujaen.es	5	4	3	2	1	6																
28/07/2021 19:42:44	9vrivas@ujaen.es	3	2	1	6	5	4																
28/07/2021 19:42:44	19vrivas@ujaen.es	3	2	1	6	5	4																
28/07/2021 19:42:44	29vrivas@ujaen.es	3	2	1	6	5	4																
28/07/2021 19:42:44	39vrivas@ujaen.es	3	2	1	6	5	4																
28/07/2021 19:42:44	49vrivas@ujaen.es	3	2	1	6	5	4																
28/07/2021 19:42:44	59vrivas@ujaen.es	3	2	1	6	5	4																
28/07/2021 19:42:44	69vrivas@ujaen.es	3	2	1	6	5	4																
28/07/2021 19:42:44	79vrivas@ujaen.es	3	2	1	6	5	4																
28/07/2021 19:42:44	89vrivas@ujaen.es	3	2	1	6	5	4																
28/07/2021 19:42:44	99vrivas@ujaen.es	3	2	1	6	5	4																
28/07/2021 19:42:44	109vrivas@ujaen.es	3	2	1	6	5	4																
28/07/2021 19:43:00	10vrivas@ujaen.es	4	5	6	1	2	3																
28/07/2021 19:43:00	20vrivas@ujaen.es	4	5	6	1	2	3																
28/07/2021 19:43:00	30vrivas@ujaen.es	4	5	6	1	2	3																
28/07/2021 19:43:00	40vrivas@ujaen.es	4	5	6	1	2	3																
28/07/2021 19:43:00	50vrivas@ujaen.es	4	5	6	1	2	3																
28/07/2021 19:43:00	60vrivas@ujaen.es	4	5	6	1	2	3																
28/07/2021 19:43:00	70vrivas@ujaen.es	4	5	6	1	2	3																
28/07/2021 19:43:00	80vrivas@ujaen.es	4	5	6	1	2	3																
28/07/2021 19:43:00	90vrivas@ujaen.es	4	5	6	1	2	3																
28/07/2021 19:43:00	100vrivas@ujaen.es	4	5	6	1	2	3																
28/07/2021 19:43:00	110vrivas@ujaen.es	4	5	6	1	2	3																
28/07/2021 19:43:11	11vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:43:11	21vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:43:11	31vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:43:11	41vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:43:11	51vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:43:11	61vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:43:11	71vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:43:11	81vrivas@ujaen.es	2	3	4	5	6	1																
28/07/2021 19:43:11	91vrivas@ujaen.es	2	3	4	5	6	1																														
																							
																							
																							
																							
																							
																							
																							
																							
																							
																							
																							
																							
																							
        </textarea>
        <br/>
        Máx. núm. de estudiantes por grupo: <input type="text" value="25" id="estudiantesPorGrupo" value="25"/>
        <br/>
        <input type="button" value="Procesar" id="btProcesar" onclick="doProcesar()"/>
        <hr/>
        <div id="consola"></div>
        <script>
            const PREFIJO = "00000000"
            let preferencias
            let cabecera
            let peticiones
            let ocupacionGrupos

            function cls() {
                consola.innerHTML=""
            }
            function write( texto ) {
                consola.innerHTML+=texto+"\n"
            }
            function writeln( texto ) {
                write( texto+"\n"+"<br/>")
            }
            
            function modificaFecha( e ) {
                var fecha=e[0]
                if( fecha.substr(0, PREFIJO.length)!=PREFIJO ) {
                    var f_h=fecha.split(" ")
                    var f=f_h[0].split( "/" )
                    e[0]=f[2]+"/"+f[1]+"/"+f[0]+" "+f_h[1]
                }
                return( e )
            }

            function Preferencia(vector) {
                this.fecha=vector[0]
                this.correo=vector[1]
                this.eleccion=vector.slice(2).map(e=>isNaN(e*1.0)?e:e*1.0) // Convierto las prioridades en números
                this.grupoAsignado = null

                this.toString=function() {
                    return this.fecha+","
                        + this.correo+","
                        + (this.grupoAsignado+1);
                }
                this.toTR=function() {
                    let msg=["<TR><TD>",this.fecha,"</TD><TD>"
                        ,this.correo,"</TD><TD>"
                        , (this.grupoAsignado+1)
                        ,"</TD></TR>"].join("")
                    return msg
                }
            }

            function ordenarCorreoFechaInversa(a,b) {
                if( a.correo==b.correo && a.fecha==b.fecha ) return 0
                if( a.correo<b.correo) return -1
                if( a.correo>b.correo) return 1
                if( a.correo==b.correo && a.fecha>b.fecha ) return -1  // ordena fechas en orden inverso para quedarse con la más reciente
                if( a.correo==b.correo && a.fecha<b.fecha ) return 1    
            }
            function ordenarFecha(a,b) {
                if( a.fecha==b.fecha ) return 0
                if( a.fecha<b.fecha ) return -1 
                if( a.fecha>b.fecha ) return 1    
            }
            // El vector p tiene que estar ordenado por Correo y por Fecha en orden inverso
            function eliminaCorreosRepetidos( p ) {
                for( let i=0; i<p.length-1; ++i ) {
                    if( p[i].correo==p[i+1].correo ) {
                        p.splice(i+1,1)
                        --i
                    }
                }
                return p
            }

            function calculaPeticionesGrupoPrioridad( preferencias, grupo, prioridad ) {
                return preferencias.filter( e=> e.eleccion[grupo]==prioridad )
            }

            function calculaPeticionesRestantesGrupoPrioridad( preferencias, grupo, prioridad ) {
                return calculaPeticionesGrupoPrioridad( preferencias, grupo, prioridad )
                    .filter( e=> e.grupoAsignado==null )
            }

            function asignaGrupo( peticiones, tamaGrupo, grupo ) {
                for( let i=0; i<tamaGrupo && i<peticiones.length && ocupacionGrupos[grupo]<tamaGrupo; ++i ) {
                    peticiones[i].grupoAsignado=grupo*1.0
                    ++ocupacionGrupos[grupo]
                }
            }


            function doProcesar() {
                cls()
                // para prevenir que la primera línea se desordene, le añado ___
                let dd=PREFIJO+datos.value
                preferencias=dd
                    .split("\n")  // Separo las líneas
                    .map((e=>(e.split("\t")
                                .filter(e=>e!=""))))  // Separo cada uno de los campos y elimino los vacíos
                    .filter(e=>e.length>=3)  // Debo tener al menos 3 campos
                    .filter(e=>(e.join("")!="")) // Filtro por las líneas que NO están vacías
                    .map(e=>modificaFecha(e)) // Pongo bien la fecha para ordenar: aaaa/mm/dd
                    .map( e=>new Preferencia(e)) // Creo un objeto con cada línea    
                console.log( "Inicialmente hay "+preferencias.length )
                preferencias=preferencias.sort(ordenarCorreoFechaInversa)
                preferencias=eliminaCorreosRepetidos( preferencias )  
                preferencias=preferencias.sort(ordenarFecha)
                grupos=preferencias[0].eleccion
                preferencias.splice(0,1)
                console.log( "Al final hay "+preferencias.length )           
                console.log( preferencias )

                tamaGrupo = estudiantesPorGrupo.value*1.0
                numGrupos = grupos.length 
                numEstudiantes = preferencias.length
                ocupacionGrupos = new Array(numGrupos)
                ocupacionGrupos.fill(0,0,numGrupos)
                writeln( "Núm estudiantes: "+preferencias.length )
                writeln( "Núm. grupos: "+grupos.length )
                grupos.forEach(e=>writeln(" - "+e));
                writeln( "Máx. núm. estudiantes por grupo: "+tamaGrupo )

                if( tamaGrupo*numGrupos<numEstudiantes ) {
                    let min=Math.round( numEstudiantes/numGrupos )
                    let sobran=numEstudiantes-tamaGrupo*numGrupos
                    alert( "El número de grupos NO es suficiente para asignar todos los estudiantes. \n"
                        + "Estudiantes no se podrán asignar a ningún grupo: "+sobran+". \n"
                        +"Mínimo grupo de estudiantes necesarios en cada grupo: "+min+"\n")
                    //return
                }
                let grupo = 0
                let prioridad = 1
                peticiones = []
                for( prioridad=1; prioridad<=grupos.length; ++prioridad ) {
                    writeln( "Para prioridad "+prioridad )
                    for( grupo in grupos ) {
                        peticiones = calculaPeticionesGrupoPrioridad( preferencias, grupo, prioridad )
                        writeln( "Núm. estudiantes en Grupo "+grupos[grupo]+ ": "+peticiones.length )
                    }
                }
                write( "<h2>Asignamos grupos</h2>" );
                for( prioridad=1; prioridad<=grupos.length; ++prioridad ) {
                    //writeln( "Para prioridad "+prioridad )
                    for( grupo in grupos ) {
                        peticiones = calculaPeticionesRestantesGrupoPrioridad( preferencias, grupo, prioridad )
                        asignaGrupo( peticiones, tamaGrupo, grupo )
                        //writeln( "Núm. estudiantes en Grupo "+grupos[grupo]+ ": "+peticiones.length )
                    }
                }

                write( "<h3>Asignaciones por prioridad</h3>" );
                for( prioridad=1; prioridad<=grupos.length; ++prioridad ) {
                    numEstudiantes=preferencias.filter(e=>e.eleccion[e.grupoAsignado]==prioridad).length
                    writeln( "Estudiantes asignados a su prioridad "+prioridad+": "+numEstudiantes )
                }
                write( "<h3>Asignaciones por grupo</h3>" );
                for( grupo=0; grupo<grupos.length; ++grupo ) {
                    numEstudiantes=preferencias.filter(e=>e.grupoAsignado==grupo).length
                    writeln( "Estudiantes asignados en el grupo "+(grupo+1)+": "+numEstudiantes )
                }

                

                write( "<h3>Listados por Grupo</h3>" );
                for( grupo=0; grupo<grupos.length; ++grupo ) {
                    estudiantes=preferencias.filter(e=>e.grupoAsignado==grupo)
                    write( "<h4>"+(grupo+1)+". "+grupos[grupo]+"<h4>")
                    let msg="<table border='1' width='80%'>\
                            <thead><th>Fecha</th><th>Email</th><th>Grupo</th><thead>\
                            <tbody>"
                        +estudiantes.map(e=>e.toTR()).join("")
                        +"</tbody></table>"
                    write( msg )
                }

                numEstudiantes=preferencias.filter(e=>e.grupoAsignado==null).length
                write( "<h3>Núm. estudiantes sin asignar: "+numEstudiantes+"</h3>" );

            }
        </script>
    </body>
</html>
